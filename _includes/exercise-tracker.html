<script>
// Global object to hold refresh functions for each day's tracker
window.refreshTracker = {};

// Modal elements
const modal = document.getElementById("edit-modal");
const modalCloseBtn = modal.querySelector(".close-button");
const modalSaveBtn = document.getElementById("modal-save");
const modalDeleteBtn = document.getElementById("modal-delete");
const modalDateInput = document.getElementById("modal-date");
const modalExerciseListDiv = document.getElementById("modal-exercise-list");

/**
 * Closes the modal window.
 */
function closeModal() {
    modal.style.display = "none";
}

/**
 * Opens the modal to add or edit a history entry.
 * @param {string} dayId - The ID for the day (e.g., 'day1').
 * @param {number} index - The index of the entry to edit, or -1 to add a new one.
 * @param {string[]} allExercises - The list of all possible exercises for that day.
 */
function openModal(dayId, index, allExercises) {
    // Store context for save/delete actions
    modal.dataset.dayId = dayId;
    modal.dataset.index = index;
    modal.dataset.allExercises = JSON.stringify(allExercises);

    const history = JSON.parse(localStorage.getItem(`${dayId}-history`) || "[]");
    const entry = index > -1 ? history[index] : null;

    // Set the date input
    const today = new Date().toLocaleDateString("en-CA", { timeZone: "America/Denver" });
    modalDateInput.value = entry ? entry.date : today;

    // Populate exercise checklist
    modalExerciseListDiv.innerHTML = '';
    allExercises.forEach(exercise => {
        const checkboxId = `modal-ex-${exercise.replace(/[^a-z0-9]/gi, '')}`;
        const isChecked = entry && entry.completed.includes(exercise);
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" value="${exercise}" id="${checkboxId}" ${isChecked ? 'checked' : ''}> ${exercise}`;
        modalExerciseListDiv.appendChild(label);
    });

    // Show/hide delete button
    modalDeleteBtn.style.display = index > -1 ? 'inline-block' : 'none';
    modal.style.display = "block";
}

// Event listeners for the modal
modalCloseBtn.onclick = closeModal;
window.onclick = (event) => {
    if (event.target == modal) {
        closeModal();
    }
};

modalSaveBtn.onclick = () => {
    const { dayId, index: indexStr } = modal.dataset;
    const index = parseInt(indexStr, 10);

    if (!modalDateInput.value) {
        alert("Please select a date.");
        return;
    }

    const completed = Array.from(modalExerciseListDiv.querySelectorAll('input:checked')).map(cb => cb.value);
    const newEntry = { date: modalDateInput.value, completed };
    const history = JSON.parse(localStorage.getItem(`${dayId}-history`) || "[]");

    if (index > -1) {
        history[index] = newEntry; // Update existing
    } else {
        history.push(newEntry); // Add new
    }

    // Sort history by date to keep it chronological
    history.sort((a, b) => new Date(a.date) - new Date(b.date));
    localStorage.setItem(`${dayId}-history`, JSON.stringify(history));

    closeModal();
    window.refreshTracker[dayId](); // Refresh the specific day's UI
    renderOverviewChart(); // Refresh the combined chart
};

modalDeleteBtn.onclick = () => {
    if (!confirm("Are you sure you want to delete this entry?")) return;

    const { dayId, index: indexStr } = modal.dataset;
    const index = parseInt(indexStr, 10);

    const history = JSON.parse(localStorage.getItem(`${dayId}-history`) || "[]");
    history.splice(index, 1);
    localStorage.setItem(`${dayId}-history`, JSON.stringify(history));

    closeModal();
    window.refreshTracker[dayId]();
    renderOverviewChart();
};


function initExerciseList(dayId, exercises, containerId, resetBtnId, chartId, historyId, clearBtnId) {
    const container = document.getElementById(containerId);
    const historyContainer = document.getElementById(historyId);
    const chartCanvas = document.getElementById(chartId);
    const resetButton = document.getElementById(resetBtnId);
    const clearButton = document.getElementById(clearBtnId);
    let chart;

    // Create exercise checkboxes
    exercises.forEach(exercise => {
        const id = `${dayId}-exercise-` + exercise.toLowerCase().replace(/[^a-z0-9]+/g, "-");
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" id="${id}"> ${exercise}`;
        container.appendChild(label);
        container.appendChild(document.createElement("br"));

        const checkbox = document.getElementById(id);
        checkbox.checked = localStorage.getItem(id) === "true";
        checkbox.addEventListener("change", () => localStorage.setItem(id, checkbox.checked));
    });

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem(`${dayId}-history`) || "[]");
        historyContainer.innerHTML = `<h3>History ${dayId.toUpperCase()}</h3>`;
        if (history.length === 0) {
            historyContainer.innerHTML += "<p>No history.</p>";
        } else {
            const list = document.createElement("ul");
            history.forEach((entry, index) => {
                const li = document.createElement("li");
                li.innerHTML = `<strong>${entry.date}:</strong> ${entry.completed.join(", ")} `;
                const editButton = document.createElement("button");
                editButton.textContent = "Edit";
                editButton.style.marginLeft = '10px';
                editButton.onclick = () => openModal(dayId, index, exercises);
                li.appendChild(editButton);
                list.appendChild(li);
            });
            historyContainer.appendChild(list);
        }

        // Add the "Add New Entry" button
        let addBtn = document.getElementById(`add-entry-${dayId}`);
        if (!addBtn) {
            addBtn = document.createElement("button");
            addBtn.id = `add-entry-${dayId}`;
            addBtn.textContent = "Add New Entry";
            addBtn.style.marginTop = '10px';
            addBtn.onclick = () => openModal(dayId, -1, exercises);
            historyContainer.insertAdjacentElement('afterend', addBtn);
        }
    }

    function renderChart() {
        const history = JSON.parse(localStorage.getItem(`${dayId}-history`) || "[]");
        const labels = history.map(e => e.date);
        const data = history.map(e => Math.round((e.completed.length / exercises.length) * 100));
        const ctx = chartCanvas.getContext("2d");

        if (chart) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        } else {
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: '% Completed',
                        data,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }
    }
    
    // Group render functions for easy refreshing
    function refreshDayUI() {
        renderHistory();
        renderChart();
    }
    
    // Register the refresh function globally
    window.refreshTracker[dayId] = refreshDayUI;

    resetButton.addEventListener("click", () => {
        const completed = exercises.filter(exercise => {
            const id = `${dayId}-exercise-` + exercise.toLowerCase().replace(/[^a-z0-9]+/g, "-");
            return document.getElementById(id)?.checked;
        });

        if (completed.length > 0) {
            const today = new Date().toLocaleDateString("en-CA", { timeZone: "America/Denver" });
            const entry = { date: today, completed };
            const history = JSON.parse(localStorage.getItem(`${dayId}-history`) || "[]");
            history.push(entry);
            history.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem(`${dayId}-history`, JSON.stringify(history));
        }

        exercises.forEach(exercise => {
            const id = `${dayId}-exercise-` + exercise.toLowerCase().replace(/[^a-z0-9]+/g, "-");
            const checkbox = document.getElementById(id);
            if (checkbox) {
                checkbox.checked = false;
                localStorage.removeItem(id);
            }
        });

        refreshDayUI();
        renderOverviewChart();
    });

    clearButton.addEventListener("click", () => {
        if (confirm(`Are you sure you want to clear all history for ${dayId.toUpperCase()}?`)) {
            localStorage.removeItem(`${dayId}-history`);
            refreshDayUI();
            renderOverviewChart();
        }
    });

    refreshDayUI(); // Initial render
}

function renderOverviewChart() {
    const day1 = JSON.parse(localStorage.getItem("day1-history") || "[]");
    const day2 = JSON.parse(localStorage.getItem("day2-history") || "[]");

    const allDates = Array.from(new Set([...day1, ...day2].map(e => e.date))).sort();
    
    const day1Total = 12;
    const day2Total = 11;
    
    const day1Map = day1.reduce((acc, e) => ({ ...acc, [e.date]: Math.round((e.completed.length / day1Total) * 100) }), {});
    const day2Map = day2.reduce((acc, e) => ({ ...acc, [e.date]: Math.round((e.completed.length / day2Total) * 100) }), {});
    
    const combinedData = allDates.map(date => {
        const combined = (day1Map[date] || 0) + (day2Map[date] || 0);
        return Math.min(combined, 100);
    });

    const ctx = document.getElementById("chart-overview").getContext("2d");
    if (window.overviewChart) {
        window.overviewChart.data.labels = allDates;
        window.overviewChart.data.datasets[0].data = combinedData;
        window.overviewChart.update();
    } else {
        window.overviewChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: allDates,
                datasets: [{
                    label: 'Combined Completion %',
                    data: combinedData,
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: { scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }
}

document.addEventListener("DOMContentLoaded", function () {
    try {
        initExerciseList("day1", [
            "Flexibility - FR back extension", "Flexibility - FR thread the needle", "Flexibility - FR cat/cow, childs pose, arm lift",
            "Flexibility - FR snow angel", "Flexibility - Pectoral stretch doorway (left side)", "Low Back - Alt superman 3x20",
            "Low Back - Decline back extension or standing back bend with medball", "Mid Back - Bent over row - 10-15 lb 3x15",
            "Mid Back - Bent over fly - 10-12 lb, 3x15", "Glutes - Staggered RDL w/ 15 lb 3x15", "Glutes - Dead lift - 15 lbs, 3x15",
            "Shoulder - Wall walks (railroad tracks)"
        ], "exercise-list-day1", "reset-exercises-day1", "chart-day1", "history-day1", "clear-history-day1");

        initExerciseList("day2", [
            "Flexibility - Open book (laying down)", "Flexibility - Kneeling archer", "Flexibility - Seated open book",
            "Flexibility - Seated desk extension w/ lift", "Low Back - Full superman 3x30s holds ", "Low Back - Bird dog w/ crunch 3x30 (band)",
            "Mid Back - Incremental flexion with medball", "Mid Back - Pull ups 3x15", "Glutes - Kneeling medball slam 3x15",
            "Glutes - Hip thrusts 25 lbs, 3x15", "Shoulders - Wall clock 12 to 6 left side"
        ], "exercise-list-day2", "reset-exercises-day2", "chart-day2", "history-day2", "clear-history-day2");

        renderOverviewChart();
        console.log("Exercise tracker initialized successfully!");
    } catch (error) {
        console.error("Error initializing exercise tracker:", error);
    }
});
</script>